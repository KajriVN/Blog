---
type Heading = {
  depth: number;
  slug: string;
  text: string;
};

type Props = {
  headings: Heading[];
};

const { headings } = Astro.props;

// Filter out h1 headings (usually the title)
const tocHeadings = headings.filter(h => h.depth > 1 && h.depth <= 3);
---

{
  tocHeadings.length > 0 && (
    <aside
      id="table-of-contents"
      class="toc-container hidden lg:block fixed top-24 left-8 w-48 max-h-[calc(100vh-8rem)] overflow-y-auto"
    >
      <nav class="toc-nav rounded-lg border border-border bg-card p-3">
        <h2 class="mb-2 text-xs font-semibold uppercase tracking-wide text-foreground">
          Table of Contents
        </h2>
        <ul class="space-y-1.5 text-xs">
          {tocHeadings.map(heading => (
            <li
              class:list={[
                "toc-item",
                {
                  "ml-0": heading.depth === 2,
                  "ml-3": heading.depth === 3,
                  "ml-6": heading.depth === 4,
                },
              ]}
            >
              <a
                href={`#${heading.slug}`}
                class="toc-link block py-0.5 text-foreground/70 hover:text-accent transition-colors duration-200"
                data-heading-id={heading.slug}
              >
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    </aside>
  )
}

<style>
  .toc-container {
    z-index: 10;
  }

  .toc-nav {
    backdrop-filter: blur(10px);
    background-color: var(--color-background);
  }

  .toc-link.active {
    color: var(--color-accent);
    font-weight: 500;
  }

  /* Custom scrollbar for TOC */
  .toc-container::-webkit-scrollbar {
    width: 4px;
  }

  .toc-container::-webkit-scrollbar-track {
    background: transparent;
  }

  .toc-container::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
  }

  .toc-container::-webkit-scrollbar-thumb:hover {
    background: var(--color-accent);
  }
</style>

<script>
  function initTableOfContents() {
    const observer = new IntersectionObserver(
      entries => {
        entries.forEach(entry => {
          const id = entry.target.getAttribute("id");
          const tocLink = document.querySelector(
            `.toc-link[data-heading-id="${id}"]`
          );

          if (entry.isIntersecting) {
            // Remove active class from all links
            document.querySelectorAll(".toc-link").forEach(link => {
              link.classList.remove("active");
            });
            // Add active class to current link
            tocLink?.classList.add("active");
          }
        });
      },
      {
        rootMargin: "-100px 0px -66%",
        threshold: 1.0,
      }
    );

    // Track all headings that have an `id` applied
    document.querySelectorAll("article h2, article h3, article h4").forEach(heading => {
      observer.observe(heading);
    });

    // Smooth scroll to heading without affecting browser history
    document.querySelectorAll(".toc-link").forEach(link => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const targetId = link.getAttribute("data-heading-id");
        const targetElement = document.getElementById(targetId || "");
        
        if (targetElement) {
          // Preserve the original backUrl in sessionStorage
          const originalBackUrl = sessionStorage.getItem("backUrl");
          
          targetElement.scrollIntoView({ behavior: "smooth", block: "start" });
          // Update URL hash without affecting history
          history.replaceState(null, "", `#${targetId}`);
          
          // Restore the original backUrl so "Go back" still works correctly
          if (originalBackUrl) {
            sessionStorage.setItem("backUrl", originalBackUrl);
          }
        }
      });
    });
  }

  // Initialize on page load
  initTableOfContents();

  // Re-initialize after view transitions
  document.addEventListener("astro:after-swap", initTableOfContents);
</script>
